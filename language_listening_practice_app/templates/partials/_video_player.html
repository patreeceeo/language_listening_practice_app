<!-- YouTube Video -->
<div class="mb-6">
  <div class="aspect-video w-full">
    <div id="player"></div>
  </div>
</div>

<!-- Buttons -->
<div class="space-y-4">
  <!-- Play Video Button -->
  <button id="VideoPlayer_playButton" class="w-full bg-white border-2 border-gray-300 text-gray-700 py-4 px-6 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-2" onclick="VideoPlayerPartial.playVideo()">
    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
      <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
    </svg>
    Play Video
  </button>
  <!-- Stop Video Button -->
  <button id="VideoPlayer_stopButton" class="hidden w-full bg-white border-2 border-gray-300 text-gray-700 py-4 px-6 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-2" onclick="VideoPlayerPartial.stopVideo()">
    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
      <rect x="5" y="5" width="10" height="10" rx="1"/>
    </svg>
    Stop Video
  </button>

<script>
  document.addEventListener('DOMContentLoaded', () => VideoPlayerPartial.init());

  // Global callback for YouTube IFrame API
  function onYouTubeIframeAPIReady() {
    VideoPlayerPartial.onYouTubeAPIReady();
  }

  const VideoPlayerPartial = {
    player: null,
    playerReady: false,
    youtubeAPIReady: false,
    pendingInit: false,
    videoParams: {
      videoId: "{{ youtube_video_id }}",
      startSeconds: {{ start_seconds }},
      endSeconds: {{ end_seconds }}
    },
    init() {
      if (this.youtubeAPIReady) {
        this.initPlayer();
      } else {
        this.pendingInit = true;
      }
    },
    onYouTubeAPIReady() {
      this.youtubeAPIReady = true;
      if (this.pendingInit) {
        this.initPlayer();
        this.pendingInit = false;
      }
    },
    initPlayer() {
      this.player = new YT.Player('player', {
        playerVars: {
          playsinline: 1,
          controls: 0,
        },
        events: {
          onReady: this.onPlayerReady.bind(this),
          onStateChange: (event) => {
            if (event.data === YT.PlayerState.ENDED) {
              this.playVideo();
            }
          }
        }
      });

      this.player.getIframe().classList.add('w-full', 'h-full', 'rounded-lg', 'shadow-lg');

    },
    playVideo() {
      if(this.playerReady) {
        // Show stop button, hide play button
        document.getElementById('VideoPlayer_playButton').classList.add('hidden');
        document.getElementById('VideoPlayer_stopButton').classList.remove('hidden');

        // Have to load the video each time to respect startSeconds
        this.player.loadVideoById(this.videoParams);
      }
    },
    stopVideo() {
      // Show play button, hide stop button
      document.getElementById('VideoPlayer_playButton').classList.remove('hidden');
      document.getElementById('VideoPlayer_stopButton').classList.add('hidden');

      // Cue an invalid video to stop playback
      this.player.cueVideoById(this.videoParams);
    },
    onPlayerReady(event) {
      this.playerReady = true;
      this.player.cueVideoById(this.videoParams);
    }
  };
</script>
