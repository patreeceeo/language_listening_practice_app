{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Create YouTube Clip{% endblock %}

{% block content %}
<div id="content-main">
  <h1>{% if is_edit %}Edit{% else %}Create{% endif %} YouTube Clip</h1>

  <div class="module" style="max-width: 900px;">
    <!-- Video ID Input -->
    <div class="form-row" style="margin-bottom: 20px;">
      <div>
        <label for="video-input">YouTube Video ID or URL:</label>
        <input
          type="text"
          id="video-input"
          placeholder="Enter video ID (e.g., dQw4w9WgXcQ) or full URL"
          style="width: 100%; padding: 8px; font-size: 14px;"
          {% if is_edit %}value="{{ clip.video_id }}"{% endif %}
        >
        <button
          type="button"
          id="load-video-btn"
          class="button"
          style="margin-top: 10px;"
        >
          Load Video
        </button>
      </div>
    </div>

    <!-- Title Input -->
    <div class="form-row" id="title-container" style="margin-bottom: 20px; {% if is_edit %}display: block;{% else %}display: none;{% endif %}">
      <div>
        <label for="title-input">Video Title:</label>
        <input
          type="text"
          id="title-input"
          placeholder="Loading title..."
          style="width: 100%; padding: 8px; font-size: 14px;"
          {% if is_edit %}value="{{ clip.title }}"{% endif %}
        >
      </div>
    </div>

    <!-- Video Player -->
    <div id="player-container" style="display: none; margin-bottom: 20px;">
      <div style="aspect-ratio: 16/9; width: 100%; max-width: 800px;">
        <div id="player"></div>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls" style="display: none;">
      <div style="margin-bottom: 20px;">
        <p id="status-message" style="font-weight: bold; color: #417690;"></p>
        <p id="time-display" style="color: #666;"></p>
      </div>

      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="button" id="set-start-btn" class="button" style="display: none;">
          Set Start Time
        </button>
        <button type="button" id="set-end-btn" class="button" style="display: none;">
          Set End Time
        </button>
        <button type="button" id="start-over-btn" class="button default" style="display: none;">
          Start Over
        </button>
        <button type="button" id="save-clip-btn" class="button" style="display: none;">
          Save Clip
        </button>
      </div>
    </div>

    <!-- Hidden Form -->
    <form id="clip-form" method="post" style="display: none;">
      {% csrf_token %}
      <input type="hidden" name="video_id" id="form-video-id">
      <input type="hidden" name="start_seconds" id="form-start-seconds">
      <input type="hidden" name="end_seconds" id="form-end-seconds">
      <input type="hidden" name="title" id="form-title">
    </form>
  </div>
</div>

<!-- Load YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
document.addEventListener('DOMContentLoaded', () => YouTubeClipCreator.init());

// YouTube API ready callback
function onYouTubeIframeAPIReady() {
  console.log('YouTube API ready');
  YouTubeClipCreator.onYouTubeAPIReady();
}

const YouTubeClipCreator = {
  player: null,
  playerReady: false,
  videoId: null,
  startSeconds: null,
  endSeconds: null,
  loopInterval: null,
  state: 'idle', // idle, loaded, start_set, end_set, previewing
  youtubeAPIReady: false,
  pendingInit: false,
  isEdit: {{ is_edit|lower }},
  {% if is_edit %}
  existingClip: {
    videoId: '{{ clip.video_id }}',
    startSeconds: {{ clip.start_seconds }},
    endSeconds: {{ clip.end_seconds }},
    title: '{{ clip.title|default:"" }}'
  },
  {% endif %}

  // Cached DOM elements
  elements: {},

  init() {
    // Cache all DOM elements
    this.elements = {
      videoInput: document.getElementById('video-input'),
      loadVideoBtn: document.getElementById('load-video-btn'),
      titleContainer: document.getElementById('title-container'),
      titleInput: document.getElementById('title-input'),
      playerContainer: document.getElementById('player-container'),
      controls: document.getElementById('controls'),
      statusMessage: document.getElementById('status-message'),
      timeDisplay: document.getElementById('time-display'),
      setStartBtn: document.getElementById('set-start-btn'),
      setEndBtn: document.getElementById('set-end-btn'),
      startOverBtn: document.getElementById('start-over-btn'),
      saveClipBtn: document.getElementById('save-clip-btn'),
      formVideoId: document.getElementById('form-video-id'),
      formStartSeconds: document.getElementById('form-start-seconds'),
      formEndSeconds: document.getElementById('form-end-seconds'),
      formTitle: document.getElementById('form-title'),
      clipForm: document.getElementById('clip-form')
    };

    // Attach event listeners
    this.elements.loadVideoBtn.addEventListener('click', () => this.onLoadVideo());
    this.elements.setStartBtn.addEventListener('click', () => this.onSetStart());
    this.elements.setEndBtn.addEventListener('click', () => this.onSetEnd());
    this.elements.startOverBtn.addEventListener('click', () => this.onStartOver());
    this.elements.saveClipBtn.addEventListener('click', () => this.onSaveClip());

    // Start time display updates
    setInterval(() => this.updateTimeDisplay(), 100);

    // If editing, prepare to auto-load the video when API is ready
    if (this.isEdit && this.existingClip) {
      this.videoId = this.existingClip.videoId;
      this.startSeconds = this.existingClip.startSeconds;
      this.endSeconds = this.existingClip.endSeconds;
      this.pendingInit = true;

      // If API is already ready, init now
      if (this.youtubeAPIReady) {
        this.initPlayer();
      }
    }
  },

  onYouTubeAPIReady() {
    this.youtubeAPIReady = true;
    // If we have a pending init (edit mode), initialize the player
    if (this.pendingInit) {
      this.initPlayer();
      this.pendingInit = false;
    }
  },

  parseVideoId(input) {
    input = input.trim();

    // Direct video ID (11 characters)
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) {
      return input;
    }

    // Various YouTube URL formats
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
    ];

    for (const pattern of patterns) {
      const match = input.match(pattern);
      if (match) return match[1];
    }

    return null;
  },

  initPlayer() {
    this.stopPreview();
    if (this.player) {
      this.player.destroy();
    }

    this.player = new YT.Player('player', {
      videoId: this.videoId,
      playerVars: {
        playsinline: 1,
        controls: 1,
      },
      events: {
        onReady: this.onPlayerReady.bind(this),
        onStateChange: this.onPlayerStateChange.bind(this)
      }
    });
  },

  onPlayerReady(event) {
    this.playerReady = true;
    this.elements.playerContainer.style.display = 'block';
    this.elements.controls.style.display = 'block';

    // If editing and clip times are set, go to preview mode
    if (this.isEdit && this.startSeconds !== null && this.endSeconds !== null) {
      this.elements.startOverBtn.style.display = 'inline-block';
      this.elements.saveClipBtn.style.display = 'inline-block';
      this.updateStatus(`Editing clip from ${this.startSeconds.toFixed(2)}s to ${this.endSeconds.toFixed(2)}s. Click "Start Over" to reset times or "Save Clip" to save changes.`);
      this.state = 'previewing';
      this.startPreview();
    } else {
      this.elements.setStartBtn.style.display = 'inline-block';
      this.updateStatus('Video loaded. Play the video and click "Set Start Time" when ready.');
      this.state = 'loaded';
    }
  },

  onPlayerStateChange(event) {
    if (this.state === 'previewing' && event.data === YT.PlayerState.ENDED) {
      // Loop back to start
      this.player.seekTo(this.startSeconds);
      this.player.playVideo();
    }
  },

  updateStatus(message) {
    this.elements.statusMessage.textContent = message;
  },

  updateTimeDisplay() {
    if (this.playerReady && this.player.getCurrentTime) {
      const currentTime = this.player.getCurrentTime().toFixed(2);
      let display = `Current time: ${currentTime}s`;
      if (this.startSeconds !== null) {
        display += ` | Start: ${this.startSeconds.toFixed(2)}s`;
      }
      if (this.endSeconds !== null) {
        display += ` | End: ${this.endSeconds.toFixed(2)}s`;
      }
      this.elements.timeDisplay.textContent = display;
    }
  },

  async fetchVideoTitle() {
    try {
      const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${this.videoId}&format=json`);
      const data = await response.json();
      this.elements.titleInput.value = data.title;
    } catch (error) {
      console.error('Failed to fetch video title:', error);
      this.elements.titleInput.value = '';
      this.elements.titleInput.placeholder = 'Could not fetch title - enter manually';
    }
  },

  onLoadVideo() {
    const input = this.elements.videoInput.value;
    this.videoId = this.parseVideoId(input);

    if (!this.videoId) {
      alert('Invalid YouTube video ID or URL');
      return;
    }

    // Reset all state
    this.startSeconds = null;
    this.endSeconds = null;
    this.state = 'idle';

    // Hide all buttons
    this.elements.setStartBtn.style.display = 'none';
    this.elements.setEndBtn.style.display = 'none';
    this.elements.startOverBtn.style.display = 'none';
    this.elements.saveClipBtn.style.display = 'none';

    // Clear messages
    this.updateStatus('');
    this.elements.timeDisplay.textContent = '';

    // Show and populate title field
    this.elements.titleContainer.style.display = 'block';
    this.elements.titleInput.value = '';
    this.elements.titleInput.placeholder = 'Loading title...';
    this.fetchVideoTitle();

    this.initPlayer();
  },

  onSetStart() {
    if (!this.playerReady) return;

    this.startSeconds = this.player.getCurrentTime();
    this.updateStatus(`Start time set to ${this.startSeconds.toFixed(2)}s. Now play to your desired end point and click "Set End Time".`);
    this.elements.setStartBtn.style.display = 'none';
    this.elements.setEndBtn.style.display = 'inline-block';
    this.state = 'start_set';
  },

  onSetEnd() {
    if (!this.playerReady || this.startSeconds === null) return;

    this.endSeconds = this.player.getCurrentTime();

    if (this.endSeconds <= this.startSeconds) {
      alert('End time must be after start time');
      return;
    }

    this.updateStatus(`Clip set! Preview playing from ${this.startSeconds.toFixed(2)}s to ${this.endSeconds.toFixed(2)}s. Click "Save Clip" when ready.`);
    this.elements.setEndBtn.style.display = 'none';
    this.elements.startOverBtn.style.display = 'inline-block';
    this.elements.saveClipBtn.style.display = 'inline-block';

    this.state = 'previewing';
    this.startPreview();
  },

  startPreview() {
    this.player.seekTo(this.startSeconds);
    this.player.playVideo();

    // Check if we need to loop
    this.stopPreview();
    this.loopInterval = setInterval(() => {
      if (this.playerReady && this.player.getCurrentTime() >= this.endSeconds) {
        this.player.seekTo(this.startSeconds);
      }
    }, 100);
  },

  stopPreview() {
    if (this.loopInterval) {
      clearInterval(this.loopInterval);
      this.loopInterval = null;
    }
  },

  onStartOver() {
    this.stopPreview();

    this.startSeconds = null;
    this.endSeconds = null;
    this.player.seekTo(0);
    this.player.pauseVideo();

    this.elements.setStartBtn.style.display = 'inline-block';
    this.elements.setEndBtn.style.display = 'none';
    this.elements.startOverBtn.style.display = 'none';
    this.elements.saveClipBtn.style.display = 'none';

    this.updateStatus('Reset. Play the video and click "Set Start Time" when ready.');
    this.state = 'loaded';
  },

  onSaveClip() {
    if (!this.videoId || this.startSeconds === null || this.endSeconds === null) {
      alert('Please set both start and end times');
      return;
    }

    this.elements.formVideoId.value = this.videoId;
    this.elements.formStartSeconds.value = this.startSeconds;
    this.elements.formEndSeconds.value = this.endSeconds;
    this.elements.formTitle.value = this.elements.titleInput.value;
    this.elements.clipForm.submit();
  }
};
</script>
{% endblock %}
